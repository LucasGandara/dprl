# Feature Specification: Cleanup Assets Folder After Metrics Visualization

**Feature Branch**: `003-cleanup-assets-folder`
**Created**: 2026-01-26
**Status**: Draft
**Input**: User description: "The add_video_from_frames function creates a video file in a folder called assets. After the MetricsPlotter class finishes, we should clean up the assets folder, remove it with its content."

## Clarifications

### Session 2026-01-26

- Q: What should happen when cleanup fails (e.g., file in use by another process)? → A: Inform user cleanup was unsuccessful, display the exact path that could not be deleted, and instruct user to manually delete the folder.

## User Scenarios & Testing *(mandatory)*

### User Story 1 - Automatic Cleanup on Session End (Priority: P1)

As a researcher running training experiments, I want the temporary video assets created during metrics visualization to be automatically cleaned up when I close the visualization dashboard, so that my project directory doesn't accumulate leftover temporary files.

**Why this priority**: This is the core functionality requested. Without automatic cleanup, users would need to manually delete the assets folder after each experiment, leading to clutter and potential disk space issues over time.

**Independent Test**: Can be fully tested by running a visualization session with video, closing the dashboard, and verifying the assets folder and its contents no longer exist.

**Acceptance Scenarios**:

1. **Given** a MetricsPlotter session with videos added via `add_video_from_frames`, **When** the user closes the visualization dashboard, **Then** the assets folder and all its contents are removed from the caller's directory.

2. **Given** a MetricsPlotter session with multiple videos added, **When** the dashboard is closed, **Then** all video files and the assets folder are removed completely.

3. **Given** a MetricsPlotter session with no videos added, **When** the dashboard is closed, **Then** no cleanup errors occur (graceful handling when assets folder doesn't exist).

---

### User Story 2 - Graceful Cleanup on Errors (Priority: P2)

As a researcher, I want the cleanup to happen even if something goes wrong during the visualization session, so that temporary files don't accumulate due to crashes or unexpected terminations.

**Why this priority**: Error handling ensures robustness. Without this, any session that ends unexpectedly would leave behind temporary files.

**Independent Test**: Can be tested by simulating an error during visualization and verifying cleanup still occurs.

**Acceptance Scenarios**:

1. **Given** a MetricsPlotter session that encounters an error, **When** the session terminates, **Then** the cleanup still attempts to remove the assets folder.

2. **Given** the assets folder has read-only files or files in use, **When** cleanup is attempted, **Then** the system informs the user that cleanup was unsuccessful, displays the exact path that could not be deleted, and instructs the user to manually delete the folder.

---

### Edge Cases

- What happens when the assets folder doesn't exist at cleanup time? → Cleanup should complete without errors.
- What happens when another process is using a file in the assets folder? → Cleanup should inform the user that cleanup was unsuccessful, display the exact path that could not be deleted, and instruct the user to manually delete the folder.
- What happens when the user manually deleted some files before cleanup? → Cleanup should remove remaining files and folder without errors.
- What happens when the user runs multiple MetricsPlotter instances from the same directory? → Each instance should only clean up assets it created, or cleanup should be coordinated to avoid conflicts.

## Requirements *(mandatory)*

### Functional Requirements

- **FR-001**: System MUST remove the assets folder and all its contents when the MetricsPlotter visualization session ends normally.
- **FR-002**: System MUST handle the case where the assets folder doesn't exist without raising errors.
- **FR-003**: System MUST handle file access errors gracefully (e.g., files in use, permission issues) by: (a) informing the user that cleanup was unsuccessful, (b) displaying the exact path that could not be deleted, and (c) instructing the user to manually delete the folder.
- **FR-004**: System MUST perform cleanup when the dashboard server is shut down, regardless of how the shutdown is initiated (user action, programmatic stop, or keyboard interrupt).
- **FR-005**: System MUST only remove the assets folder that was created by the current MetricsPlotter instance (identified by the caller directory).

### Key Entities

- **Assets Folder**: A temporary directory created in the caller's directory to store video files generated by `add_video_from_frames`. Contains video files in MP4 format.
- **MetricsPlotter Instance**: The visualization component that manages the lifecycle of the assets folder, from creation to cleanup.

## Success Criteria *(mandatory)*

### Measurable Outcomes

- **SC-001**: 100% of normal visualization sessions result in complete cleanup of the assets folder and its contents.
- **SC-002**: The caller's directory returns to its pre-visualization state (no assets folder present) after the session ends.
- **SC-003**: Cleanup completes within 5 seconds of session termination for typical use cases (1-10 video files).
- **SC-004**: Zero orphaned assets folders remain after running 100 consecutive visualization sessions.
- **SC-005**: Users receive clear feedback if cleanup cannot be completed (e.g., files locked by another process).

## Assumptions

- The assets folder is only used for temporary video storage during visualization and has no need to persist after the session.
- Users do not need to retain the generated videos after viewing them in the dashboard (if retention is needed, users should manually copy files before closing).
- The MetricsPlotter is the sole owner of the assets folder it creates and can safely delete it.
- The Dash server shutdown event provides a reliable hook for triggering cleanup operations.
